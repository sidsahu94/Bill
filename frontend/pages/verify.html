<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify OTP - Bill</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="bg-light">
  <div id="navbar-placeholder"></div>

  <main class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-5">
        <div class="card p-4 shadow-sm">
          <h4 class="mb-3">Verify your email</h4>

          <div id="verifyAlert" role="status" aria-live="polite" style="display:none;"></div>

          <form id="verifyForm" novalidate>
            <div class="mb-3">
              <label for="email" class="form-label">Email address</label>
              <input id="email" name="email" type="email" class="form-control" required autocomplete="email" placeholder="you@example.com" />
            </div>

            <div class="mb-3">
              <label for="otp" class="form-label">OTP (6-digit)</label>
              <input id="otp" name="otp" type="text" inputmode="numeric" pattern="\d{6}" class="form-control" required autocomplete="one-time-code" placeholder="Enter OTP" />
              <div class="form-text">Check your email for the 6-digit code. Expires in 15 minutes.</div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Verify</button>
              <button id="resendOtpBtn" type="button" class="btn btn-outline-secondary">Resend OTP</button>
            </div>
          </form>

          <div class="mt-3">
            <a href="/pages/login.html">Back to login</a> · <a href="/pages/register.html">Register</a>
          </div>

          <hr />

          <div>
            <h6 class="small text-muted">Debug / Server response</h6>
            <pre id="debug" style="max-height:180px; overflow:auto; white-space:pre-wrap;"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>

<script src="/js/navbar.js"></script>

<script>
  // Helpers
  function showAlert(message, type = 'info') {
    const el = document.getElementById('verifyAlert');
    el.className = `alert alert-${type} mt-2`;
    el.style.display = 'block';
    el.textContent = message;
    setTimeout(() => { el.style.display = 'none'; }, type === 'success' ? 2500 : 6000);
  }

  function writeDebug(obj) {
    const dbg = document.getElementById('debug');
    try { dbg.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2); }
    catch { dbg.textContent = String(obj); }
    console.log('VERIFY DEBUG:', obj);
  }

  // Prefill email from localStorage or URL query
  (function prefillEmail() {
    const q = new URLSearchParams(location.search);
    const emailParam = q.get('email');
    const stored = localStorage.getItem('email') || localStorage.getItem('userEmail');
    if (emailParam) document.getElementById('email').value = emailParam;
    else if (stored) document.getElementById('email').value = stored;
  })();

  document.getElementById('verifyForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const otp = document.getElementById('otp').value.trim();

    if (!email) return showAlert('Please enter email', 'warning');
    if (!otp) return showAlert('Please enter OTP', 'warning');

    // Save email locally to help UX later
    localStorage.setItem('email', email);

    try {
      const res = await fetch('/api/auth/verify-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, otp })
      });

      // raw & parsed body for debugging
      const raw = await res.text();
      let parsed;
      try { parsed = JSON.parse(raw); } catch (err) { parsed = raw; }

      writeDebug({ status: res.status, headers: Array.from(res.headers.entries()), bodyRaw: raw, body: parsed });

      if (!res.ok) {
        const msg = (parsed && (parsed.message || parsed.msg)) ? (parsed.message || parsed.msg) : `Verify failed (status ${res.status})`;
        // Helpful handling for common messages:
        if (/not verified|invalid/i.test(msg) && /already registered/i.test(msg) === false) {
          // if invalid OTP or expired -> give clear instruction
          showAlert(msg, 'danger');
        } else {
          showAlert(msg, 'danger');
        }
        return;
      }

      showAlert('Verified successfully — you can now login', 'success');
      // short delay then go to login
      setTimeout(() => window.location = '/pages/login.html', 900);

    } catch (err) {
      console.error('verify error', err);
      writeDebug(err);
      showAlert('Network error while verifying. Check server.', 'danger');
    }
  });

  document.getElementById('resendOtpBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    if (!email) return showAlert('Enter email to resend OTP', 'warning');
    try {
      const res = await fetch('/api/auth/resend-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const raw = await res.text();
      let parsed;
      try { parsed = JSON.parse(raw); } catch (err) { parsed = raw; }
      writeDebug({ resendStatus: res.status, bodyRaw: raw, body: parsed });
      if (!res.ok) {
        const msg = (parsed && (parsed.message || parsed.msg)) ? (parsed.message || parsed.msg) : `Resend failed (status ${res.status})`;
        showAlert(msg, 'danger');
        return;
      }
      showAlert('OTP resent — check your email (or server logs if SMTP not configured).', 'success');
    } catch (err) {
      console.error('resend error', err);
      showAlert('Network error while resending OTP', 'danger');
    }
  });
</script>
</body>
</html>
